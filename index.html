<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¸ ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³è©¦åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls label {
      margin: 0 10px;
    }
    .controls button {
      font-size: 1.2em;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 8px;
    }
    .court {
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      margin: 10px;
      font-size: 1.5em;
      text-align: center;
      background: #f9f9f9;
    }
    .court-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 5px 10px;
      text-align: center;
    }
    .message {
      text-align: center;
      font-size: 1.2em;
      margin-top: 15px;
      color: blue;
    }
  </style>
</head>
<body>
  <h1>ğŸ¸ ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³è©¦åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

  <div class="controls">
    <label>äººæ•°: <span id="playerCountLabel">4</span></label>
    <input type="range" id="playerCount" min="2" max="20" value="4">
    
    <label>ã‚³ãƒ¼ãƒˆæ•°: <span id="courtCountLabel">2</span></label>
    <input type="range" id="courtCount" min="1" max="10" value="2">

    <label>è©¦åˆå½¢å¼:</label>
    <select id="matchType">
      <option value="singles">ã‚·ãƒ³ã‚°ãƒ«ã‚¹</option>
      <option value="doubles">ãƒ€ãƒ–ãƒ«ã‚¹</option>
    </select>

    <button id="generate">è©¦åˆç”Ÿæˆ</button>
    <button id="addPlayer">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ </button>
    <button id="removePlayer">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤</button>
    <input type="number" id="removeId" placeholder="å‰Šé™¤ç•ªå·" min="1" style="width:80px;">
  </div>

  <h2>ã‚³ãƒ¼ãƒˆä¸€è¦§</h2>
  <div class="court-container" id="courts"></div>

  <div class="table-container">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·è¡¨</h2>
    <table id="playerTable">
      <thead>
        <tr><th>ç•ªå·</th><th>çŠ¶æ…‹</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-container">
    <h2>ç•ªå·ç®¡ç†è¡¨</h2>
    <table id="numberTable">
      <thead>
        <tr><th>ä½¿ç”¨ä¸­ã®ç•ªå·</th><th>ç©ºå¸­ç•ªå·</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="message" id="message"></div>

  <script>
    let players = {};
    let availableIds = [];
    let nextId = 1;
    let matchHistory = []; // è©¦åˆã”ã¨ã®å±¥æ­´

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    function createPlayer(id) {
      return {
        id: id,
        matches: 0,
        lastMatch: -1,
        opponents: {},
        partners: {}
      };
    }

    function updateTables() {
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·è¡¨
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";
      Object.keys(players).sort((a,b)=>a-b).forEach(id => {
        let row = document.createElement("tr");
        row.innerHTML = `<td>${id}</td><td>å‚åŠ ä¸­</td>`;
        tbody.appendChild(row);
      });

      // ç•ªå·ç®¡ç†è¡¨
      const numBody = document.querySelector("#numberTable tbody");
      numBody.innerHTML = "";
      let used = Object.keys(players).sort((a,b)=>a-b).join(", ") || "-";
      let empty = availableIds.sort((a,b)=>a-b).join(", ") || "-";
      let row = document.createElement("tr");
      row.innerHTML = `<td>${used}</td><td>${empty}</td>`;
      numBody.appendChild(row);

      document.getElementById("playerCountLabel").innerText = Object.keys(players).length;
      document.getElementById("playerCount").value = Object.keys(players).length;
    }

    function addPlayer() {
      let id;
      if (availableIds.length > 0) {
        id = availableIds.shift();
      } else {
        id = nextId++;
      }
      players[id] = createPlayer(id);
      document.getElementById("message").innerText = `æ–°ã—ã ${id} ç•ªã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`;
      updateTables();
    }

    function removePlayer() {
      const id = parseInt(document.getElementById("removeId").value);
      if (!id || !players[id]) {
        document.getElementById("message").innerText = `ç•ªå· ${id} ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å­˜åœ¨ã—ã¾ã›ã‚“`;
        return;
      }
      delete players[id];
      availableIds.push(id);
      document.getElementById("message").innerText = `${id} ç•ªã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ`;
      updateTables();
    }

    // é¸æ‰‹é¸å‡ºã®åŸºæœ¬ã‚½ãƒ¼ãƒˆé–¢æ•°
    function sortPlayers(candidates) {
      return candidates.sort((a,b)=>{
        if (players[a].matches !== players[b].matches) {
          return players[a].matches - players[b].matches;
        }
        if (players[a].lastMatch !== players[b].lastMatch) {
          return players[a].lastMatch - players[b].lastMatch;
        }
        return a - b;
      });
    }

    // è©¦åˆç”Ÿæˆ
    function generateMatches() {
      Object.values(players).forEach(p => {
        p.matches = 0;
        p.lastMatch = -1;
        p.opponents = {};
        p.partners = {};
      });
      matchHistory = [];
      const courtCount = parseInt(document.getElementById("courtCount").value);
      const matchType = document.getElementById("matchType").value;
      const courtsDiv = document.getElementById("courts");
      courtsDiv.innerHTML = "";
      let ids = Object.keys(players).map(Number).sort((a,b)=>a-b);

      if (matchType === "singles") {
        for (let c=0; c<courtCount; c++) {
          if (ids.length < 2) break;
          let [p1, p2] = ids.splice(0,2);
          makeMatch([p1],[p2],c+1,courtsDiv);
        }
      } else {
        for (let c=0; c<courtCount; c++) {
          if (ids.length < 4) break;
          let [p1,p2,p3,p4] = ids.splice(0,4);
          makeMatch([p1,p2],[p3,p4],c+1,courtsDiv);
        }
      }
      updateTables();
    }

    function makeMatch(team1, team2, court, parent) {
      let div = document.createElement("div");
      div.className = "court";
      div.innerText = `ã‚³ãƒ¼ãƒˆ${court}: ${team1.join("&")} vs ${team2.join("&")}`;
      parent.appendChild(div);

      let matchId = matchHistory.length;
      matchHistory.push({team1,team2});

      [...team1,...team2].forEach(pid=>{
        players[pid].matches++;
        players[pid].lastMatch = matchId;
      });
    }

    document.getElementById("addPlayer").addEventListener("click", addPlayer);
    document.getElementById("removePlayer").addEventListener("click", removePlayer);
    document.getElementById("generate").addEventListener("click", generateMatches);

    // åˆæœŸ4äºº
    for (let i=0;i<4;i++) addPlayer();
  </script>
</body>
</html>
